# Progress

## Done
- Created initial memory-bank docs: `tech-stack.md`, `architecture.md`, `implementation-plan.md`, `progress.md`.
- Captured stack details from GDD into `tech-stack.md`.
- Integrated critical review updates into GDD (night mode, label mapping, UI gesture handling, opt-in ads, RLS, backend validation).
- Updated memory-bank docs to reflect new architecture, stack, and plan notes.
- Filled `implementation-plan.md` with phases, milestones, and risks.
- Added `database-schema.md` with draft tables and RLS policy examples.
- Finalized table/field naming and added RPC vs Edge Function split in schema docs.
- Updated architecture and tech stack notes to reflect the hybrid approach.
- Added `label-mapping.md` with seed mappings and quest keywords.
- Generated Supabase schema migration and seed data for label mappings/quests.
- Added `create_room` RPC and ownership transfer trigger for room owner changes.
- Added `leave_room` RPC to deactivate membership and trigger owner transfer.
- Added `regenerate_invite_code` RPC for owner-only invite refresh.
- Clarified owner-only invite code sharing in the GDD.
- Refined implementation plan with per-phase testing steps.
- Reformatted the GDD for readability without changing content.
- Added MVP designer checklist to the GDD.
- Simplified designer deliverables to interface design, component library, and pet assets.
- Added non-Figma asset handoff guidance in the GDD.
- Added asset format table and Rive material guidance to the GDD.
- Restructured GDD section 7.4 for clearer designer deliverables.
- Implemented Phase 0 scaffold: Flutter project, env setup, CI, auth gate, and profile stub.
- Added Supabase env template and README setup guidance.
- Updated architecture and tech stack docs to reflect Phase 0 modules and CI.
- Marked Phase 0 as completed in the implementation plan.
- Added `award_quest_reward` RPC to grant daily quest bonus safely.
- Added `feed_validate` Edge Function to validate labels, award feed/quest coins, and store feed messages.
- Fixed RLS recursion on `room_members` with `is_room_member` helper.
- Fixed `create_room` RPC ambiguity for `invite_code`.
- Added in-app test tools: Create Test Room + Run Feed Test.
- Added auth debug logging for JWT + UID on sign-in.
- Temporarily disabled `verify_jwt` for `feed_validate` due to Edge gateway JWT rejection; function still validates via `auth.getUser()`.
- Marked Phase 1 as completed and started Phase 2 in the implementation plan.
- Added pet state machine migration with mood boosts, poop penalties, and night mode decay.
- Wired `feed_validate` to apply pet feed actions before awarding coins.
- Added in-app pet action/state test panel (feed/clean/touch/tick).
- Applied pet state machine migration to Supabase.
- Implemented label mapping service and unit tests for matching logic.
- Implemented feed camera flow with ML Kit labeling and edge upload.
- Implemented chat room view with realtime stream, text composer, and feed cards.
- Added keyset pagination for loading older chat messages.
- Polished chat pagination UI with pull-to-refresh and loading placeholders.
- Fixed chat room sent messages not auto-updating with optimistic UI pattern.
- Removed chat room pull-to-refresh (Realtime handles new messages, scroll pagination handles old).
- Added auto-load existing room on login (no need to create test room every time).
- Fixed chat room load-more pagination (Supabase query builder is immutable, `.or()` filter wasn't being applied).
- Added "scroll to latest" button when reading older messages.
- Applied `label_mappings` and `quests` seed data to Supabase.
- Added integration test for feed -> Edge -> DB -> chat message.
- Fixed chat list refresh after feed and room switching.
- Cleaned analyzer warnings by wiring debug state into UI and removing unused imports/locals.
- Added memory calendar view (monthly grid + day detail sheet) for feed messages.
- Added report/block actions on chat messages and filtered blocked users from chat.
- Added webhook hook in `feed_validate` to notify partner events when configured.
- Added `device_tokens` table for multi-device FCM storage and updated FCM service to upsert tokens there.
- Enforced single-device storage by making `device_tokens.user_id` unique and upserting by user.
- Guarded FCM token fetch until APNS token is ready and added Apple sign-in error handling hints.
- Added retry loop for FCM token fetch to avoid APNS timing errors on iOS.
- Registered for remote notifications in iOS AppDelegate to ensure APNS token issuance.
- Added `notify_friend` Edge Function to send FCM pushes via device tokens.
- Added a local script to test `notify_friend` and documented it in testing notes.
- Added join-room UI via invite code in the home screen and drawer.
- Fixed join-room dialog to avoid disposing a controller while the dialog is closing.
- Added owner-only “regenerate invite code” action in the room drawer.
- Ensure a profile row exists on home load to avoid pet action failures.
- Added webhook status details to feed debug output for notification troubleshooting.
- Fixed `notify_friend` JWT signing by importing the private key via WebCrypto.
- Added local notifications for foreground FCM messages on iOS/Android.
- Documented iOS clean build steps in README.
- Added a debug button to trigger a local notification.
- Enabled iOS notification presentation in foreground via AppDelegate delegate.
- Fixed iOS AppDelegate notification delegate conformance and iOS 14+ presentation options.
- Added per-token failure details in `notify_friend` responses for FCM debugging.
- Resolved FCM/APNs auth error by confirming Firebase APNs key configuration; feed push now delivers.
- Removed debug logging from client code now that notification flow is stable.
- Marked Phase 3 as completed (basic report/block accepted) and moved to Phase 4; hardening deferred.
- Added store UI with coin balance, inventory state, and coin-only purchase flow.
- Added minimal store catalog seed data with JPY metadata.
- Added `purchase_item_with_coins` RPC and `store_purchase` ledger source for coin spending.

## Next
- Re-enable `verify_jwt` for `feed_validate` after resolving Edge gateway JWT validation.
- Continue Phase 4 monetization work (IAP/subscription, then rewarded ads).
